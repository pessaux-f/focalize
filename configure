#!/bin/sh

#**********************************************************************#
#                                                                      #
#                        FoCaLize compiler                             #
#                                                                      #
#            François Pessaux                                          #
#            Pierre Weis                                               #
#            Damien Doligez                                            #
#                                                                      #
#                               LIP6  --  INRIA Rocquencourt           #
#                                                                      #
#  Copyright 2008 INRIA                                                #
#  Distributed only by permission.                                     #
#                                                                      #
#**********************************************************************#

# $Id: configure,v 1.19 2008-12-19 11:05:22 weis Exp $

# Fix the name and version of the software
PROJECT_NAME=focalize
MAIN_VERSION_NUMBER=0
SUB_VERSION_NUMBER=1
PATCH_VERSION_NUMBER=rc0
FULL_VERSION_NUMBER=${MAIN_VERSION_NUMBER}.${SUB_VERSION_NUMBER}.${PATCH_VERSION_NUMBER}
FULL_PROJECT_NAME=${PROJECT_NAME}-${FULL_VERSION_NUMBER}

# The absolute path of this set of source files.
ABSOLUTE_ROOT_DIR=`pwd`

check () {
  type "$1" >/dev/null 2>&1
}

# Default settings.

DEFAULT_DEBUG=true

# General defaults for the package installation.
DEFAULT_PREFIX="/usr/local"

DEFAULT_LIB_DIR="${DEFAULT_PREFIX}/lib"
DEFAULT_BIN_DIR="${DEFAULT_PREFIX}/bin"
DEFAULT_MAN_DIR="${DEFAULT_PREFIX}/man"
DEFAULT_DOC_DIR="${DEFAULT_PREFIX}/doc"

# General defaults for the installation of the external tools of the package.
DEFAULT_SHARE_PROJECT_PREFIX="${DEFAULT_PREFIX}/share"
DEFAULT_SHARE_PROJECT_DIR="${DEFAULT_SHARE_PROJECT_PREFIX}/${FULL_PROJECT_NAME}"
DEFAULT_SHARE_PROJECT_BIN_DIR="${DEFAULT_SHARE_PROJECT_DIR}/bin"

#DEFAULT_SHARE_PROJECT_LIB_DIR="${DEFAULT_SHARE_PROJECT_DIR}/lib"
#DEFAULT_SHARE_PROJECT_MAN_DIR="${DEFAULT_SHARE_PROJECT_DIR}/man"
#DEFAULT_SHARE_PROJECT_DOC_DIR="${DEFAULT_SHARE_PROJECT_DIR}/doc"

# Defaults for Caml.
DEFAULT_CAML_BYT="${DEFAULT_SHARE_PROJECT_BIN_DIR}/ocamlc"
DEFAULT_CAML_BIN="${DEFAULT_SHARE_PROJECT_BIN_DIR}/ocamlopt"
DEFAULT_CAML_YAC="${DEFAULT_SHARE_PROJECT_BIN_DIR}/ocamlyacc"
DEFAULT_CAML_LEX="${DEFAULT_SHARE_PROJECT_BIN_DIR}/ocamllex"

# Defaults for Coq.
DEFAULT_COQC="${DEFAULT_SHARE_PROJECT_BIN_DIR}/coqc"
DEFAULT_COQRC="$HOME/.coqrc"
DEFAULT_COQ_MAKE="gmake"

# Defaults for Zenon.
DEFAULT_ZENON="${DEFAULT_SHARE_PROJECT_BIN_DIR}/zenon"
DEFAULT_USE_COQC=true
DEFAULT_SUM=:
DEFAULT_CONVERT=:
DEFAULT_GS=:

# Defaults for Zvtov.
DEFAULT_ZVTOV="${DEFAULT_SHARE_PROJECT_BIN_DIR}/zvtov"
DEFAULT_USE_XMLRPC=false
DEFAULT_XMLRPC=xmlrpc
DEFAULT_XMLRPC_FLAGS=""
DEFAULT_XMLRPC_LINK=""

#
# Generic aborting procedures.
#
abort_configuration () {
  echo;
  echo "configure: ABORTING CONFIGURATION!";
  echo;
  echo "$1";
}

abort_remedy () {
  echo;
  echo "$1";
  echo "(See configure -help for details).";
  exit 1;
}

abort_configuration_not_writable_share_prefix_directory () {
  abort_configuration \
    "You cannot install external tools in the directory $1: it is not writable for you.";
  abort_remedy \
    "Please, use configure with the \"-share_prefix\" option set to a writable directory.";
}

#
# Parsing arguments
#
while : ; do
  case $# in 0) break;; esac

  case "$1" in
    # Software specific options
    -share_prefix | --share_prefix | -share_project_prefix | --share_project_prefix)
      SHARE_PROJECT_PREFIX="$2"; shift 2;;
    -prefix | --prefix) PREFIX="$2"; shift 2;;
    -bindir | --bindir) BIN_DIR="$2"; shift 2;;
    -libdir | --libdir) LIB_DIR="$2"; shift 2;;
    -docdir | --docdir) DOC_DIR="$2"; shift 2;;
    -mandir | --mandir) MAN_DIR="$2"; shift 2;;
    # Caml options
    -caml_byt | --caml_byt) CAML_BYT="$2"; shift 2;;
    -caml_bin | --caml_bin) CAML_BIN="$2"; shift 2;;
    # Coq options
    -coqc | --coqc) COQC="$2"; shift 2;;
    -coqrc | --coqrc) COQRC="$2"; shift 2;;
    -coq_make | --coq_make) COQ_MAKE="$2"; shift 2;;
    # Zenon options
    -zenon | --zenon) ZENON="$2"; shift 2;;
    -use_coqc | --use_coqc) USE_COQC="$2"; shift 2;;
    -convert | --convert) CONVERT="$2"; shift 2;;
    -gs | --gs) GS="$2"; shift 2;;
    -sum | --sum) SUM="$2"; shift 2;;
    # Zvtov options
    -zvtov | --zvtov) ZVTOV="$2"; shift 2;;
    -use_xmlrpc | --use_xmlrpc) USE_XMLRPC=true; shift;;
    -xmlrpc | --xmlrpc) XMLRPC="$2"; shift 2;;
    -xmlrpc_flags | --xmlrpc_flags) XMLRPC_FLAGS="$2"; shift 2;;
    -xmlrpc_link | --xmlrpc_link) XMLRPC_LINK="$2"; shift 2;;
    # Generic options
    -debug | --debug | -enable_debug | --enable_debug)
     DEBUG=true; shift;;
    -nodebug | --nodebug | -disable_debug | --disable_debug)
     DEBUG=false; shift;;
    -help | --help)
       echo "usage: ./configure [options] [<directory>]"
       echo
       echo "if optional argument <directory> is provided, it is used as the"
       echo "[-share_prefix] option (see below)."
       echo
       echo "general options are:"
       echo
       echo "  [-]-share_prefix <directory>"
       echo "    set <directory> as the directory prefix for the installation of external tools."
       echo "    External tools are mandatory for ${PROJECT_NAME} to work,"
       echo "    and must be built and installed during configuration phase,"
       echo "    since they are needed to correctly compile, install, and safely use"
       echo "    ${PROJECT_NAME}."
       echo "    External tools install in the directory <directory>/${FULL_PROJECT_NAME}/,"
       echo "    once they have ben built."
       echo "    As a consequence, you must have the permission to install directories"
       echo "    and files in <directory> to properly configure ${PROJECT_NAME}."
       echo "    (Default value for <directory> is ${DEFAULT_SHARE_PROJECT_PREFIX}.)"
       echo "  [-]-prefix <directory>"
       echo "    set <directory> as the directory prefix for installation of ${PROJECT_NAME}."
       echo "    (Default value for <directory> is ${DEFAULT_PREFIX}.)"
       echo "  [-]-bindir <directory>"
       echo "    set <directory> as the binary directory for installation of binaries for ${PROJECT_NAME}."
       echo "    (Default value for <directory> is ${DEFAULT_BIN_DIR}.)"
       echo "  [-]-libdir <directory>"
       echo "    set <directory> as the library directory for installation of libraries for ${PROJECT_NAME}."
       echo "    (Default value for <directory> is ${DEFAULT_LIB_DIR}.)"
       echo "  [-]-docdir <directory>"
       echo "    set <directory> as the directory for installation of documentation for ${PROJECT_NAME}."
       echo "    (Default value for <directory> is ${DEFAULT_DOC_DIR}.)"
       echo "  [-]-mandir <directory>"
       echo "    set <directory> as the directory for installation of man pages for ${PROJECT_NAME}."
       echo "    (Default value for <directory> is ${DEFAULT_MAN_DIR}.)"
       echo "  [-]-debug | [-]-enable_debug"
       echo "    enable debugging"
       echo "  [-]-nodebug | [-]-disable_debug"
       echo "    disable debugging"
       echo "  [-]-help";
       echo "    display help and exit"
       echo
       echo "options specific to Zenon are:"
       echo
       echo "  [-]-zenon <executable-file>"
       echo "    set absolute path for the command zenon."
       echo "  [-]-use_coqc <boolean>"
       echo "    set if coqc must be used to verify the proofs given by zenon."
       echo "  [-]-convert <executable-file>"
       echo "    set absolute path for the command convert."
       echo "  [-]-gs <executable-file>"
       echo "    set absolute path for the command gs."
       echo "  [-]-sum <executable-file>"
       echo "    set absolute path for the check-sum command."
       echo
       echo "options specific to Zvtov are:"
       echo
       echo "  [-]-zvtov <executable-file>"
       echo "    set absolute path for the command zvtov."
       echo "  [-]-use_xmlrpc";
       echo "    configure zvtov to use xmlrpc."
       echo "  [-]-xmlrpc <executable-file>";
       echo "    set absolute path for the command xmlrpc."
       echo "  [-]-xmlrpc_flags <string>";
       echo "    set the string option argument to pass to xmlrpc invocations."
       echo "  (Default value for <string> is:";
       echo "   \"\`ocamlfind query -r -i-format xmlrpc | tr '\\\\012' ' '\`\").";
       echo "  [-]-xmlrpc_link <string>";
       echo "    set the link options to pass when linking xmlrpc.";
       echo "  (Default value for <string> is:";
       echo "   \"\`ocamlfind query -r -predicates byte -a-format xmlrpc | tr '\\\\012' ' '\`\").";
       echo
       echo "options specific to Caml are:"
       echo
       echo "  [-]-camlc_byt <executable-file>"
       echo "    set absolute path for the Caml byte code compiler."
       echo "  [-]-camlc_bin <executable-file>"
       echo "    set absolute path for the Caml binary compiler."
       echo
       echo "options specific to Coq are:"
       echo
       echo "  [-]-coqc <executable-file>"
       echo "    set absolute path for the command coqc."
       echo "  [-]-coqrc <file>"
       echo "    set absolute path for coqrc, the startup file for coqc."
       exit 0
       ;;
    -*)
       echo "./configure: bad option '$1'" >&2
       echo "For help, use ./configure -help" >&2
       exit 2
       ;;
    *)
       case $# in
         1) SHARE_PROJECT_PREFIX="$1"; shift;;
         *)
           echo "./configure: bad arguments '$@'" >&2
           echo "For help, use ./configure -help" >&2
           exit 2
           ;;
       esac
       ;;
  esac
done

#
# Auxiliaries to set up variables for various tools.
#

set_XMLRPC () {
  if test -z "$XMLRPC"; then XMLRPC="$DEFAULT_XMLRPC"; fi
}

set_XMLRPC_FLAGS () {
  if test -z "$XMLRPC_FLAGS"; then
    if check "ocamlfind"; then
      XMLRPC_FLAGS="`ocamlfind query -r -i-format xmlrpc | tr '\012' ' '`"
    else
      XMLRPC_FLAGS="${DEFAULT_XMLRPC_FLAGS}"
    fi
  fi
}

set_XMLRPC_LINK () {
  if test -z "$XMLRPC_LINK"; then
    if check "ocamlfind"; then
      XMLRPC_LINK="`ocamlfind query -r -predicates byte -a-format xmlrpc | tr '\012' ' '`"
    else
      XMLRPC_LINK="${DEFAULT_XMLRPC_LINK}"
    fi
  fi
}

set_USE_XMLRPC () {
 if test -z "$USE_XMLRPC"; then USE_XMLRPC=${DEFAULT_USE_XMLRPC}; fi
 if test $USE_XMLRPC; then
   set_XMLRPC;
   set_XMLRPC_FLAGS;
   set_XMLRPC_LINK;
 fi;
}

set_DEBUG () {
  if test -z $DEBUG; then DEBUG=${DEFAULT_DEBUG}; fi
  if test $DEBUG; then
    BYT_DEBUG_FLAGS="-g";
    BIN_DEBUG_FLAGS="-dtypes";
  fi
}

set_dirs () {
  if test -z "${PREFIX}"; then PREFIX="${DEFAULT_PREFIX}"; fi
  if test -z "${BIN_DIR}"; then BIN_DIR="${PREFIX}/bin"; fi
  if test -z "${LIB_DIR}"; then LIB_DIR="${PREFIX}/lib"; fi
  if test -z "${DOC_DIR}"; then DOC_DIR="${PREFIX}/doc"; fi
  if test -z "${MAN_DIR}"; then MAN_DIR="${PREFIX}/man"; fi
  if test -z "${SHARE_PROJECT_PREFIX}";
    then SHARE_PROJECT_PREFIX="${DEFAULT_SHARE_PROJECT_PREFIX}"; fi
  SHARE_PROJECT_DIR="${SHARE_PROJECT_PREFIX}/${FULL_PROJECT_NAME}"
  SHARE_PROJECT_BIN_DIR="${SHARE_PROJECT_DIR}/bin"
  SHARE_PROJECT_LIB_DIR="${SHARE_PROJECT_DIR}/lib"
  SHARE_PROJECT_DOC_DIR="${SHARE_PROJECT_DIR}/doc"
  SHARE_PROJECT_MAN_DIR="${SHARE_PROJECT_DIR}/man"
}

set_COQ_MAKE () {
  if test -z "${COQ_MAKE}"; then
    # To compile Coq, prefer gmake, if GNU make is available with that name.
    if check "${DEFAULT_COQ_MAKE}"; then COQ_MAKE="${DEFAULT_COQ_MAKE}";
    # Otherwise, use make (which is GNU make anyway on boxes with GNU make as default!).
    else COQ_MAKE="make";
    fi
  fi
}

set_software_specific_options () {
  set_dirs
}

set_caml_specific_options () {
  if test -z "${CAML_BYT}"; then CAML_BYT="${DEFAULT_CAML_BYT}"; fi
  if test -z "${CAML_BIN}"; then CAML_BIN="${DEFAULT_CAML_BIN}"; fi
  if test -z "${CAML_LEX}"; then CAML_BIN="${DEFAULT_CAML_LEX}"; fi
  if test -z "${CAML_YAc}"; then CAML_BIN="${DEFAULT_CAML_YAC}"; fi
}

set_coq_specific_options () {
  if test -z "${COQC}"; then COQC="${DEFAULT_COQC}"; fi
  if test -z "${COQRC}"; then COQRC="${DEFAULT_COQRC}"; fi
  set_COQ_MAKE;
}

set_zenon_specific_options () {
  if test -z "${ZENON}"; then ZENON="${DEFAULT_ZENON}"; fi
  if test -z "${USE_COQC}"; then USE_COQC="${DEFAULT_USE_COQC}"; fi
  if test -z "${CONVERT}"; then CONVERT="${DEFAULT_CONVERT}"; fi
  if test -z "${GS}"; then GS="${DEFAULT_GS}"; fi
  if test -z "${SUM}"; then SUM="${DEFAULT_SUM}"; fi
}

set_zvtov_specific_options () {
  if test -z "${ZVTOV}"; then ZVTOV="${DEFAULT_ZVTOV}"; fi
  set_USE_XMLRPC;
}

set_generic_options () {
  set_DEBUG;
}

set_variables () {
  set_software_specific_options;
  set_caml_specific_options;
  set_coq_specific_options;
  set_zenon_specific_options;
  set_zvtov_specific_options;
  set_generic_options;
}

#
# Validity checking for installation of external tools.
#
check_installation_dirs () {
  # The list of directories that must be installable during configuration.
  CONFIGURATION_INSTALLABLE_DIRS="${SHARE_PROJECT_PREFIX}"
  for i in ${CONFIGURATION_INSTALLABLE_DIRS}; do
    echo "Checking if we can install in $i...";
    if test -d $i; then echo "  the directory exists: good.";
      else
        echo "  the directory does not exist: unrecoverable failure.";
        abort_configuration \
          "You cannot install in $i, because it is not a directory.";
        abort_remedy \
          "Please, create a directory where you can install files and directories.";
    fi
    if test -w $i; then echo "  the directory is writable: good.";
      else
        echo "  the directory is not writable: unrecoverable failure.";
        abort_configuration_not_writable_share_prefix_directory "$i";
    fi
    if (touch $i/$$; rm -f $i/$$); then echo "  you can install in the directory: good.";
      else
        echo "  you cannot install in the directory: unrecoverable failure.";
        abort_configuration_not_writable_share_prefix_directory "$i";
    fi
  done
}

#
# Editing ./.config_var.in with what we learnt here.
#
build_config_var () {
  sed -e "s,@PROJECT_NAME@,$PROJECT_NAME," \
      -e "s,@MAIN_VERSION_NUMBER@,$MAIN_VERSION_NUMBER," \
      -e "s,@SUB_VERSION_NUMBER@,$SUB_VERSION_NUMBER," \
      -e "s,@PATCH_VERSION_NUMBER@,$PATCH_VERSION_NUMBER," \
      -e "s,@FULL_VERSION_NUMBER@,$FULL_VERSION_NUMBER," \
      -e "s,@FULL_PROJECT_NAME@,$FULL_PROJECT_NAME," \
  \
      -e "s,@ABSOLUTE_ROOT_DIR@,$ABSOLUTE_ROOT_DIR," \
      -e "s,@PREFIX@,$PREFIX," \
      -e "s,@BIN_DIR@,$BIN_DIR," \
      -e "s,@LIB_DIR@,$LIB_DIR," \
      -e "s,@DOC_DIR@,$DOC_DIR," \
      -e "s,@MAN_DIR@,$MAN_DIR," \
      -e "s,@SHARE_PROJECT_PREFIX@,$SHARE_PROJECT_PREFIX," \
      -e "s,@SHARE_PROJECT_DIR@,$SHARE_PROJECT_DIR," \
      -e "s,@SHARE_PROJECT_BIN_DIR@,$SHARE_PROJECT_BIN_DIR," \
      -e "s,@SHARE_PROJECT_LIB_DIR@,$SHARE_PROJECT_LIB_DIR," \
      -e "s,@SHARE_PROJECT_DOC_DIR@,$SHARE_PROJECT_DOC_DIR," \
      -e "s,@SHARE_PROJECT_MAN_DIR@,$SHARE_PROJECT_MAN_DIR," \
  \
      -e "s,@CAML_BYT@,$CAML_BYT," \
      -e "s,@CAML_BIN@,$CAML_BIN," \
      -e "s,@BYT_DEBUG_FLAGS@,$BYT_DEBUG_FLAGS," \
      -e "s,@BIN_DEBUG_FLAGS@,$BIN_DEBUG_FLAGS," \
  \
      -e "s,@COQC@,$COQC," \
      -e "s,@COQRC@,$COQRC," \
      -e "s,@COQ_MAKE@,$COQ_MAKE," \
  \
      -e "s,@ZENON@,$ZENON," \
      -e "s,@USE_COQC@,$USE_COQC," \
      -e "s,@CONVERT@,$CONVERT," \
      -e "s,@GS@,$GS," \
      -e "s,@SUM@,$SUM," \
  \
      -e "s,@ZVTOV@,$ZVTOV," \
      -e "s,@USE_XMLRPC@,$USE_XMLRPC," \
      -e "s,@XMLRPC@,$XMLRPC," \
      -e "s,@XMLRPC_FLAGS@,$XMLRPC_FLAGS," \
      -e "s,@XMLRPC_LINK@,$XMLRPC_LINK," \
  \
      <.config_var.in >.config_var
}

# Bootstrapping .depend.
touch_depends () {
  touch ./.depend;
  touch tarballs/.depend;
}

#
# Copying information gathered here to internal tools.
#
configure_auto () {
  cp -f .config_var zenon/;
  cp -f .config_var zvtov/;
  cp -f .config_var focalizec/;
}

summarize_configuration () {
  echo
  echo "*******************************************************"
  echo "Summary of configuration settings summary for focalize:"
  echo
  cat .config_var
  echo
  echo "End of Summary of configuration settings for focalize."
  echo "******************************************************"
}

#
# The main procedure.
#
main () {
#  parse_arguments;
  set_variables;
  check_installation_dirs;
  build_config_var;
  touch_depends;
  configure_auto;
  summarize_configuration;
  # Call the Makefile to go on configuring external tools.
  make configure_external;
}

main; exit 0
