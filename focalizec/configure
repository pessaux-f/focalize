#!/bin/sh

#**********************************************************************#
#                                                                      #
#                        FoCaLize compiler                             #
#                                                                      #
#            François Pessaux                                          #
#            Pierre Weis                                               #
#            Damien Doligez                                            #
#                                                                      #
#                               LIP6  --  INRIA Rocquencourt           #
#                                                                      #
#  Copyright 2008 INRIA                                                #
#  Distributed only by permission.                                     #
#                                                                      #
#**********************************************************************#

#  $Id: configure,v 1.21 2008-12-01 19:00:06 weis Exp $

# Default settings
PREFIX=/usr/local
DEBUG=true
USE_XMLRPC=false

set_dirs () {
  BIN_DIR="${PREFIX}/bin"
  LIB_DIR="${PREFIX}/lib/focalize"
}

set_dirs

SUB_DIRS="basement parser typing \
  docgen commoncodegen mlcodegen coqcodegen \
  toplevel \
  refman \
  stdlib \
  extlib extlib/algebra extlib/access_control \
  contribs"

# Touching .depend files to oblige make to redo dependancies
touch .depend

for i in $SUB_DIRS ; do
  (cd $i; touch .depend; mkdir -p odoc)
done

BOLDTAG="\033[1m"
UNDERLINETAG="\033[4m"
NORMALTAG="\033[0m"

echo -e $BOLDTAG"Where to install FoCaL binaries ?"$NORMALTAG
echo -e "Default is $BIN_DIR."
echo -e "Press enter to use the default location."
read USER_INPUT
case "$USER_INPUT" in
  "") ;;
  *) BIN_DIR="$USER_INPUT";;
esac

echo -e $BOLDTAG"Where to install FoCaLize libraries ?"$NORMALTAG
echo -e "Default is $LIB_DIR."
echo -e "Just press enter to use default location."
read USER_INPUT
case "$USER_INPUT" in
  "") ;;
  *) LIB_DIR="$USER_INPUT";;
esac

# Generate the installation related source file.
rm -rf basement/installation.ml
echo "(* This file is automatically generated by configure. Do not manually edit. *)" \
     > basement/installation.ml
echo "let install_bin_dir = \"$BIN_DIR\" ;;" >> basement/installation.ml
echo "let install_lib_dir = \"$LIB_DIR\" ;;" >> basement/installation.ml
echo "(* End of generated source file. *)" >> basement/installation.ml
chmod a-w basement/installation.ml

# Building dependancy files
make depend

if $DEBUG; then
  BYT_DEBUG_FLAGS="-g"
  BIN_DEBUG_FLAGS="-dtypes"
else
  BYT_DEBUG_FLAGS=
  BIN_DEBUG_FLAGS=
fi

if $USE_XMLRPC; then
  XMLRPC=xmlrpc
  XMLRPCFLAGS="`ocamlfind query -r -i-format xmlrpc | tr '\012' ' '`"
  XMLRPCLINK="`ocamlfind query -r -predicates byte -a-format xmlrpc | tr '\012' ' '`"
else
  XMLRPC=
  XMLRPCFLAGS=
  XMLRPCLINK=
fi

sed -e "s,@BIN_DIR@,$BIN_DIR," \
    -e "s,@LIB_DIR@,$LIB_DIR," \
    -e "s,@PREFIX@,$PREFIX," \
    -e "s,@BYT_DEBUG_FLAGS@,$BYT_DEBUG_FLAGS," \
    -e "s,@BIN_DEBUG_FLAGS@,$BIN_DEBUG_FLAGS," \
\
    -e "s,@CONVERT@,$CONVERT," \
    -e "s,@COQC@,$COQC," \
    -e "s,@GS@,$GS," \
    -e "s,@SUM@,$SUM," \
\
    -e "s,@XMLRPC@,$XMLRPC," \
    -e "s,@XMLRPC_FLAGS@,$XMLRPC_FLAGS," \
    -e "s,@XMLRPC_LINK@,$XMLRPC_LINK," \
    <.config_var.in >.config_var

echo "Configuration summary for focalize:"
cat .config_var

# Summary feedback.
#echo -e "Configuration summary for focalizec:"
#echo -e "  binaries -> $BIN_DIR"
#echo -e "  libraries -> $LIB_DIR"

#echo "Done. Now, please invoke: make all"
