#  Copyright 2004 INRIA
#  $Id: Makefile.in,v 1.6 2007-07-04 13:16:04 pessaux Exp $

# directories
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
foclibdir	= @foclibdir@

# programs
CAMLC = @CAMLC@
CAMLLEX = @CAMLLEX@
CAMLYACC = @CAMLYACC@

# flags
DEBUGFLAG	= @DEBUGFLAG@
XMLRPCFLAGS	= @XMLRPCFLAGS@
XMLRPCLINK	= @XMLRPCLINK@
CAMLFLAGS	= -warn-error A
CAMLCFLAGS	= $(CAMLFLAGS) $(DEBUGFLAG) $(XMLRPCFLAGS)

# switches
XMLRPCFILE	= @XMLRPCFILE@

MODULES = version misc \
          cache \
          expr parser_coq lexer_coq invoke invoke_cime \
          $(XMLRPCFILE) token lexer parser options main

LEXERS = lexer_coq lexer
PARSERS = parser_coq

PLAIN_MODULES = version misc cache invoke expr invoke_cime $(XMLRPCFILE) \
                token parser options main

IMPL = $(MODULES:%=%.ml)
INTF = $(MODULES:%=%.mli)

# packaging
PACKAGE_VERSION         = @PACKAGE_VERSION@
EXTRA_VERSION           = @EXTRA_VERSION@

DIST_DIR                = ../focal-$(PACKAGE_VERSION)$(EXTRA_VERSION)/zvtov

DIST_FILES              = $(LEXERS:=.mll) $(PARSERS:=.mly) $(MODULES:=.mli) \
                          $(PLAIN_MODULES:=.ml) Makefile.in .depend

OBJBYT = $(MODULES:%=%.cmo)

.PHONY: all
all: zvtov


zvtov: $(OBJBYT)
	$(CAMLC) $(CAMLCFLAGS) str.cma $(XMLRPCLINK) -o zvtov $(OBJBYT)

.PHONY: install
install:
	mkdir -p "$(DESTDIR)$(bindir)"
	cp zvtov $(DESTDIR)$(bindir)/

.PHONY: uninstall
uninstall:
	rm -f $(bindir)/zvtov

.SUFFIXES: .ml .mli .cmo .cmi .cmx

.ml.cmo:
	$(CAMLC) $(CAMLCFLAGS) -c $*.ml

.mli.cmi:
	$(CAMLC) $(CAMLCFLAGS) -c $*.mli

lexer.ml: lexer.mll
	$(CAMLLEX) lexer.mll

lexer_coq.ml: lexer_coq.mll
	$(CAMLLEX) lexer_coq.mll

parser_coq.ml: parser_coq.mly
	$(CAMLYACC) -v parser_coq.mly

parser_coq.mli: parser_coq.ml
	:


# distributing files
.PHONY: dist
dist:
	mkdir -p $(DIST_DIR)
	cp $(DIST_FILES) $(DIST_DIR)

.PHONY: clean
clean:
	rm -f *.cmo *.cmi *.annot
	rm -f lexer_coq.ml parser_coq.ml
	rm -f parser_coq.mli
	rm -f zvtov

.PHONY: realclean
realclean: clean
	rm -f .config_var

.PHONY: depend
depend: $(IMPL) $(INTF)
	ocamldep $(IMPL) $(INTF) >.depend

include .depend
