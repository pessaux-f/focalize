#**********************************************************************#
#                                                                      #
#                        FoCaLize compiler                             #
#                                                                      #
#            François Pessaux                                          #
#            Pierre Weis                                               #
#            Damien Doligez                                            #
#                                                                      #
#                               LIP6  --  INRIA Rocquencourt           #
#                                                                      #
#  Copyright 2008 LIP6 and INRIA                                       #
#  Distributed only by permission.                                     #
#                                                                      #
#**********************************************************************#

# $Id: Makefile.config,v 1.41 2009-01-30 11:32:24 weis Exp $

# Reading software configuration variables.
include $(ROOT_DIR)/.config_var

# Where we store ready to use documentation files.
DOCUMENTATION_DIR=$(ROOT_DIR)/documentation

# Basic Unix commands
CD = cd
CP = cp -f
CPR = cp -fr
CHMODGR = chmod g+r
CHMODGRW = chmod g+rw
CHMODR = chmod +r
CHMODRX = chmod +rx
CHMODX = chmod +x
LN = ln -sf
MAKE = make
MKDIR = mkdir -p
MV = mv -f
RM = rm -rf
TARC = tar cvzf
TARX = tar xvzf
TOUCH = touch

#
## MANAGING EXTERNAL TOOLS ##
#

# Focalize distribution includes the external tools that are MANDATORY for
# focalize to work properly.
# We must provide almost all their transitive closure :(
# The first step of the installation process is to untar, compile and install
# all those tools.

# Where the installation will take place:

# The directory where the tar balls are stored.
TAR_BALLS_DIR_NAME = tarballs
TAR_BALLS_DIR = $(ROOT_DIR)/$(TAR_BALLS_DIR_NAME)
ABSOLUTE_TAR_BALLS_DIR = $(ABSOLUTE_ROOT_DIR)/$(TAR_BALLS_DIR_NAME)

# For each tool, we define its sub-directory, its tar ball file name,
# its configuration options, and make all target.

# The Caml compiler
CAML_NAME = caml
CAML_SRC_DIR_NAME = ocaml-3.10.2
CAML_SRC_DIR = $(ROOT_DIR)/$(CAML_SRC_DIR_NAME)
ABSOLUTE_CAML_SRC_DIR = $(ABSOLUTE_ROOT_DIR)/$(CAML_SRC_DIR_NAME)

# Where are Caml libraries.
CAML_SRC_LIB_DIR = "$(ABSOLUTE_CAML_SRC_DIR)/lib"

CAML_TAR_BALL = $(CAML_SRC_DIR_NAME).tar.gz
CAML_TAR_BALLS = $(CAML_TAR_BALL)

CAML_CONFIGURE_OPTIONS = -prefix "$(TOOLS_PROJECT_DIR)"

CAML_MAKE_ALL_TARGET = world.opt

# Caml executable files
CAML_BYT_NAME = ocamlc
CAML_BIN_NAME = ocamlopt
CAML_DEP_NAME = ocamldep
CAML_DOC_NAME = ocamldoc
CAML_LEX_NAME = ocamllex
CAML_YAC_NAME = ocamlyacc

CAML_SRC_BYT = $(ABSOLUTE_CAML_SRC_DIR)/$(CAML_BYT_NAME)
CAML_SRC_BIN = $(ABSOLUTE_CAML_SRC_DIR)/$(CAML_BIN_NAME)
CAML_SRC_DEP = $(ABSOLUTE_CAML_SRC_DIR)/$(CAML_DEP_NAME)
CAML_SRC_DOC = $(ABSOLUTE_CAML_SRC_DIR)/$(CAML_DOC_NAME)
CAML_SRC_LEX = $(ABSOLUTE_CAML_SRC_DIR)/$(CAML_LEX_NAME)
CAML_SRC_YAC = $(ABSOLUTE_CAML_SRC_DIR)/$(CAML_YAC_NAME)

CAML_SRC_BYT_EXE = $(CAML_SRC_BYT)
CAML_SRC_BIN_EXE = $(CAML_SRC_BIN)
CAML_SRC_DEP_EXE = $(CAML_SRC_DEP)
CAML_SRC_DOC_EXE = $(CAML_SRC_DOC)
CAML_SRC_LEX_EXE = $(CAML_SRC_LEX)
CAML_SRC_YAC_EXE = $(CAML_SRC_YAC)

CAML_SRC_EXES = \
 $(CAML_SRC_BYT)\
 $(CAML_SRC_BIN)\
 $(CAML_SRC_DEP)\
 $(CAML_SRC_DOC)\
 $(CAML_SRC_LEX)\
 $(CAML_SRC_YAC)

# Need to define those, to honorate generic target doc and depend.
# The *_COMPILER values are defined in ./.config_var after configuration
# (hence before this makefile can be called).
CAML_DEP=$(CAML_DEP_COMPILER)
CAML_DOC=$(CAML_DOC_COMPILER)

# The CamlP5 pre-processor
CAMLP5_NAME = camlp5
CAMLP5_SRC_DIR_NAME = camlp5-5.09
CAMLP5_SRC_DIR = $(ROOT_DIR)/$(CAMLP5_SRC_DIR_NAME)
ABSOLUTE_CAMLP5_SRC_DIR = $(ABSOLUTE_ROOT_DIR)/$(CAMLP5_SRC_DIR_NAME)

CAMLP5_TAR_BALL = $(CAMLP5_SRC_DIR_NAME).tgz
CAMLP5_PATCH_TAR_BALL = $(CAMLP5_SRC_DIR_NAME)_patch.tgz
CAMLP5_TAR_BALLS = $(CAMLP5_TAR_BALL) $(CAMLP5_PATCH_TAR_BALL)

CAMLP5_CONFIGURE_OPTIONS = \
 -transitional\
 -prefix "$(TOOLS_PROJECT_DIR)"

CAMLP5_MAKE_ALL_TARGET = world.opt

# CamlP5 executables
CAMLP5_SRC_EXE = $(ABSOLUTE_CAMLP5_SRC_DIR)/$(CAMLP5_NAME)

CAMLP5_SRC_EXES = \
 $(CAMLP5_SRC_EXE)

# The Coq proof assistant
COQ_NAME = coq
COQ_SRC_DIR_NAME = coq-8.1pl4
COQ_SRC_DIR = $(ROOT_DIR)/$(COQ_SRC_DIR_NAME)
ABSOLUTE_COQ_SRC_DIR = $(ABSOLUTE_ROOT_DIR)/$(COQ_SRC_DIR_NAME)

# Where are the Coq libraries.
COQ_SRC_LIB_DIR = $(ABSOLUTE_COQ_SRC_DIR)/lib

COQ_TAR_BALL = $(COQ_SRC_DIR_NAME).tar.gz
COQ_PATCH_TAR_BALL = $(COQ_SRC_DIR_NAME)_patch.tgz
COQ_TAR_BALLS = $(COQ_TAR_BALL) $(COQ_PATCH_TAR_BALL)

COQ_CONFIGURE_OPTIONS = \
 -prefix "$(TOOLS_PROJECT_DIR)"\
 -camldir "$(CAML_BIN_DIR)"\
 -camlp5dir "$(CAMLP5_LIB_DIR)"\
 -reals all\
 -coqide no

COQ_MAKE_ALL_TARGET = world

# Coq executable files
COQC_NAME = coqc

COQC_SRC = $(ABSOLUTE_COQ_SRC_DIR)/$(COQC_NAME)

COQC_SRC_EXE = $(COQC_SRC)

COQ_SRC_EXES = \
 $(COQC_SRC)

# Convenient abbrevs for all external tools stuff.
EXTERNAL_TOOLS_TAR_BALLS = $(CAML_TAR_BALL) $(CAMLP5_TAR_BALL) $(COQ_TAR_BALL)
EXTERNAL_TOOLS_DIRS = \
 $(ABSOLUTE_CAML_SRC_DIR) $(ABSOLUTE_CAMLP5_SRC_DIR) $(ABSOLUTE_COQ_SRC_DIR)
EXTERNAL_TOOLS_EXES = $(CAML_SRC_EXES) $(CAMLP5_SRC_EXES) $(COQ_SRC_EXES)

EXTERNAL_TOOLS = $(CAML_NAME) $(CAMLP5_NAME) $(COQ_NAME)

#
## MANAGING INTERNAL TOOLS ##
#

# Internal tools are zenon (the automatic proof generator), zvtov (the
# translator from zenon proofs to coq proof lambda-terms), and focalizec (the
# compiler for focalize programs).
# All these tools are compiled in turn after configuration.

# Zenon
ZENON_NAME = zenon
ZENON_SRC_DIR_NAME = $(ZENON_NAME)
ZENON_SRC_DIR = $(ROOT_DIR)/$(ZENON_SRC_DIR_NAME)
ABSOLUTE_ZENON_SRC_DIR = $(ABSOLUTE_ROOT_DIR)/$(ZENON_SRC_DIR_NAME)

# Where are Zenon libraries.
# ZENON_LIB_DIR = $(ABSOLUTE_ZENON_DIR)/lib

ZENON_CONFIGURE_OPTIONS = \
 -debug "$(DEBUG)"\
 -static_external "true"\
 -prefix "$(TOOLS_PROJECT_DIR)"\
 -caml_prefix "$(CAML_PREFIX)"\
 -coq_prefix "$(COQ_PREFIX)"\
 -coq_rc "$(COQ_RC)"\
 -use_coq_compiler "$(USE_COQ_COMPILER)"\
 -sum "$(SUM)"\
 -convert "$(CONVERT)"\
 -gs "$(GS)"

ZENON_MAKE_ALL_TARGET = all

ZENON_EXE_NAME = $(ZENON_NAME)
ZENON_EXE = $(ABSOLUTE_ZENON_DIR)/$(ZENON_EXE_NAME)

ZENON_EXES = $(ZENON_EXE)

# Zvtov
ZVTOV_NAME = zvtov
ZVTOV_SRC_DIR_NAME = $(ZVTOV_NAME)
ZVTOV_EXE_NAME = $(ZVTOV_NAME)
ZVTOV_SRC_DIR = $(ROOT_DIR)/$(ZVTOV_SRC_DIR_NAME)
ABSOLUTE_ZVTOV_SRC_DIR = $(ABSOLUTE_ROOT_DIR)/$(ZVTOV_SRC_DIR_NAME)

ZVTOV_CONFIGURE_OPTIONS = \
 -debug "$(DEBUG)"\
 -static_external "true"\
 -prefix "$(TOOLS_PROJECT_DIR)"\
 -caml_prefix "$(CAML_PREFIX)"\
 -coq_prefix "$(COQ_PREFIX)"\
 -coq_rc "$(COQ_RC)"\
 -zenon_prefix "$(ZENON_PREFIX)" \
 -use_coq_compiler "$(USE_COQ_COMPILER)"\
 -sum "$(SUM)"\
 -convert "$(CONVERT)"\
 -gs "$(GS)"\
 -use_xmlrpc "$(USE_XMLRPC)"\
 -xmlrpc_flags "$(XMLRPC_FLAGS)"\
 -xmlrpc_link "$(XMLRPC_LINK)"

ZVTOV_MAKE_ALL_TARGET = all

ZVTOV_EXE = $(ABSOLUTE_ZVTOV_DIR)/$(ZVTOV_EXE_NAME)
ZVTOVC = $(ZVTOV_EXE)

ZVTOV_EXES = $(ZVTOVC)

# Focalizec
FOCALIZEC_NAME = focalizec
FOCALIZEC_SRC_DIR_NAME = $(FOCALIZEC_NAME)
FOCALIZEC_SRC_DIR = $(ROOT_DIR)/$(FOCALIZEC_SRC_DIR_NAME)
ABSOLUTE_FOCALIZEC_SRC_DIR = $(ABSOLUTE_ROOT_DIR)/$(FOCALIZEC_SRC_DIR_NAME)

FOCALIZEC_DIR = $(ABSOLUTE_FOCALIZEC_SRC_DIR)/lib

FOCALIZEC_CONFIGURE_OPTIONS = \
 -debug "$(DEBUG)"\
 -static_external "true"\
 -prefix "$(PREFIX)"\
 -caml_prefix "$(CAML_PREFIX)"\
 -coq_prefix "$(COQ_PREFIX)"\
 -coq_rc "$(COQ_RC)"\
 -zenon_prefix "$(ZENON_PREFIX)"\
 -use_coq_compiler "$(USE_COQ_COMPILER)"\
 -sum "$(SUM)"\
 -convert "$(CONVERT)"\
 -gs "$(GS)"\
 -zvtov_prefix "$(ZVTOV_PREFIX)"\
 -use_xmlrpc "$(USE_XMLRPC)"\
 -xmlrpc_flags "$(XMLRPC_FLAGS)"\
 -xmlrpc_link "$(XMLRPC_LINK)"

FOCALIZEC_MAKE_ALL_TARGET = all

FOCALIZEC_EXE_NAME = $(FOCALIZEC_NAME)
FOCALIZEC_EXE = $(ABSOLUTE_FOCALIZEC_DIR)/$(FOCALIZEC_EXE_NAME)
FOCALIZEC = $(FOCALIZEC_EXE)

FOCALIZEC_EXES = "$(FOCALIZEC)"

INTERNAL_TOOLS = $(ZENON_NAME) $(ZVTOV_NAME) $(FOCALIZEC_NAME)
INTERNAL_TOOLS_DIRS = $(ZENON_SRC_DIR) $(ZVTOV_SRC_DIR) $(FOCALIZEC_SRC_DIR)
INTERNAL_TOOLS_EXES = $(ZENON_EXES) $(ZVTOV_EXES) $(FOCALIZEC_EXES)
INTERNAL_TOOLS_MAKE_ALL_TARGET = all
